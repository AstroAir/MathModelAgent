# 文件上传功能使用指南

## 功能概述

MathModelAgent 的文件上传功能已优化，现在支持以下三种上传方式：

1. **单个/多个文件上传**
2. **文件夹上传**（包含完整的目录结构）
3. **压缩包上传**（自动解压）

## 前端改进

### 新增功能

#### 1. 上传方式选择按钮
- **上传文件** - 支持多选文件
- **上传文件夹** - 上传整个文件夹，保留目录结构

#### 2. 支持的文件格式
- **数据文件**: `.txt`, `.csv`, `.xlsx`, `.xls`, `.json`, `.xml`
- **压缩包**: `.zip`, `.rar`, `.7z`, `.tar`, `.tar.gz`

#### 3. 文件列表显示
- 显示文件名和文件大小
- 支持滚动查看大量文件
- 自动截断过长的文件名

### 使用方法

#### 方法 1: 上传单个或多个文件
1. 点击"上传文件"按钮
2. 在文件选择对话框中选择一个或多个文件
3. 点击"打开"

#### 方法 2: 上传文件夹
1. 点击"上传文件夹"按钮
2. 选择要上传的文件夹
3. 系统会自动上传文件夹中的所有文件，并保留目录结构

#### 方法 3: 上传压缩包
1. 点击"上传文件"按钮
2. 选择压缩包文件（.zip, .rar, .7z 等）
3. 后端会自动解压并提取所有文件

## 后端改进

### 新增功能

#### 1. 文件夹结构保存
- 自动识别上传文件的路径信息
- 在工作目录中重建完整的目录结构
- 支持嵌套的子目录

#### 2. 压缩包自动解压
系统支持以下压缩格式：
- **ZIP** (`.zip`)
- **RAR** (`.rar`)
- **7Z** (`.7z`)
- **TAR** (`.tar`, `.tar.gz`, `.tar.bz2`, `.tar.xz`)

#### 3. 文件处理流程
```
上传文件 → 检测文件类型 → 保存到工作目录
    ├─ 普通文件: 直接保存
    ├─ 文件夹文件: 重建目录结构后保存
    └─ 压缩包: 自动解压 → 删除原始压缩包
```

### 技术实现

#### 新增工具模块
创建了 `app/utils/file_utils.py`，包含以下功能：
- `is_archive_file()` - 检测是否为压缩包
- `extract_archive()` - 解压压缩包
- `save_uploaded_file()` - 保存上传的文件
- `get_file_tree()` - 获取目录树结构
- `count_files_in_directory()` - 统计文件数量

#### 路由更新
更新了 `modeling_router.py` 中的 `/modeling` 接口：
- 支持文件路径解析（处理子目录）
- 自动检测和解压压缩包
- 准确统计文件数量

## 依赖安装

为支持新功能，需要安装以下 Python 库：

```bash
# 使用 uv（推荐）
uv add py7zr rarfile

# 或使用 pip
pip install py7zr rarfile
```

### 依赖说明
- `py7zr>=0.22.0` - 支持 7Z 格式压缩包
- `rarfile>=4.2` - 支持 RAR 格式压缩包
- Python 内置的 `zipfile` 和 `tarfile` - 支持 ZIP 和 TAR 格式

## 使用示例

### 示例 1: 上传数据集文件夹
```
dataset/
  ├── train.csv
  ├── test.csv
  └── metadata.json
```
直接选择 `dataset` 文件夹上传，系统会保留完整的目录结构。

### 示例 2: 上传压缩包
上传 `data.zip`，系统会自动解压：
```
data.zip → 解压后 →
  ├── data1.csv
  ├── data2.csv
  └── subfolder/
      └── data3.csv
```

### 示例 3: 混合上传
可以同时上传：
- 单个文件 `problem.txt`
- 压缩包 `dataset.zip`
- 文件夹 `images/`

系统会自动处理所有文件。

## 注意事项

1. **文件大小限制**: 根据服务器配置，可能存在文件大小限制
2. **压缩包解压**: RAR 格式需要系统安装 `unrar` 工具
3. **文件名**: 建议使用英文文件名，避免特殊字符
4. **目录结构**: 上传文件夹时会保留完整的目录结构
5. **压缩包清理**: 解压成功后会自动删除原始压缩包

## 错误处理

### 常见错误

#### RAR 解压失败
```
错误: RAR解压失败: Cannot find working tool
解决: 安装 unrar 工具
  - Windows: 下载 WinRAR 或 unrar.exe
  - Linux: sudo apt-get install unrar
  - macOS: brew install unrar
```

#### 7Z 解压失败
```
错误: 不支持 7Z 格式（需要安装 py7zr 库）
解决: pip install py7zr
```

#### 文件夹上传失败
```
错误: 部分浏览器不支持文件夹上传
解决: 
  - 使用 Chrome、Edge 或 Firefox 浏览器
  - 或者先将文件夹压缩为 .zip 文件再上传
```

## 性能优化建议

1. **大文件处理**: 对于大量文件，建议先压缩后上传
2. **网络优化**: 使用压缩包可以减少网络传输时间
3. **批量上传**: 系统支持一次上传多个文件或文件夹

## 更新日志

### v1.0 (当前版本)
- ✅ 支持文件夹上传
- ✅ 支持多种压缩格式（ZIP, RAR, 7Z, TAR）
- ✅ 自动解压压缩包
- ✅ 保留目录结构
- ✅ 优化文件列表显示
- ✅ 显示文件大小信息

## 技术支持

如有问题，请：
1. 查看日志文件
2. 检查依赖库是否正确安装
3. 联系技术支持团队
